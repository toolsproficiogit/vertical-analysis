name: Security Checks

on:
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 6 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  semgrep:
    name: Semgrep SAST
    runs-on: ubuntu-latest
    continue-on-error: true
    container:
      image: semgrep/semgrep
    steps:
      - uses: actions/checkout@v6
      - name: Run Semgrep
        run: |
          semgrep scan \
            --config p/security-audit \
            --config p/secrets \
            --config p/owasp-top-ten \
            --config p/typescript \
            --error \
            --metrics=off \
            --exclude node_modules \
            --exclude dist \
            --exclude .vite \
            --exclude build \
            .

  trivy:
    name: Trivy Vulnerability Scan
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          output: 'trivy-results.txt'
          severity: 'HIGH,CRITICAL'
          exit-code: '1'

      - name: Post Trivy results to PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const results = fs.readFileSync('trivy-results.txt', 'utf8').trim();

            let body;
            if (results) {
              // Parse severity counts from Trivy table output
              // Lines like: Total: 8 (HIGH: 6, CRITICAL: 2)
              const totalLines = results.match(/Total:\s*\d+\s*\([^)]+\)/g) || [];
              let high = 0, critical = 0;
              for (const line of totalLines) {
                const hm = line.match(/HIGH:\s*(\d+)/);
                const cm = line.match(/CRITICAL:\s*(\d+)/);
                if (hm) high += parseInt(hm[1], 10);
                if (cm) critical += parseInt(cm[1], 10);
              }
              const total = high + critical;

              const parts = [];
              if (critical > 0) parts.push(`**${critical} critical**`);
              if (high > 0) parts.push(`**${high} high**`);
              const summary = total > 0
                ? `Found ${total} vulnerabilities: ${parts.join(', ')}`
                : 'Found vulnerabilities';

              body = [
                '## Trivy Vulnerability Scan',
                '',
                summary,
                'This is informational only â€” it does not block the PR.',
                '',
                '<details><summary>View full scan results</summary>',
                '',
                '```',
                results,
                '```',
                '',
                '</details>',
              ].join('\n');
            } else {
              body = '## Trivy Vulnerability Scan\n\nNo HIGH or CRITICAL vulnerabilities found.';
            }

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c =>
              c.body.includes('## Trivy Vulnerability Scan') &&
              c.user.type === 'Bot'
            );
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
